<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Overview</title>
    <script>
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const waiterName = urlParams.get('name');
            const tenant = getTenantFromHostname();
            let isDragMode = false; // flag for drag mode

            console.log(`Waiter Name: ${waiterName}`);
            console.log(`Tenant: ${tenant}`);

            if (waiterName) {
                localStorage.setItem('waiterName', waiterName);
                updateHeader(waiterName, tenant);
            } else {
                updateHeader('', tenant);
            }

            if (tenant) {
                console.log(`Tenant found: ${tenant}`);
                loadTables(tenant);
            } else {
                console.error('Tenant not found in hostname.');
            }

            window.addEventListener('resize', () => {
                const tenant = getTenantFromHostname();
                loadTables(tenant);
            });

            resizeContainer();
            window.addEventListener('resize', resizeContainer);

            // Listen for button clicks to toggle drag mode and arrange buttons
            document.getElementById('toggle-drag-mode').addEventListener('click', () => {
                isDragMode = !isDragMode;
                console.log(`Drag mode: ${isDragMode}`);
                toggleDragMode(isDragMode);
                document.getElementById('toggle-drag-mode').classList.toggle('active', isDragMode);
            });

            document.getElementById('arrange-buttons').addEventListener('click', arrangeButtons);

            function enableDrag(element) {
                element.draggable = true;

                element.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.id);
                });
            }

            function toggleDragMode(enable) {
                const buttons = document.querySelectorAll('.tables-container a');
                buttons.forEach(button => {
                    if (enable) {
                        enableDrag(button);
                        button.style.border = '2px dashed red';
                    } else {
                        button.draggable = false;
                        button.style.border = 'none';
                    }
                });

                const container = document.querySelector('.tables-container');
                if (enable) {
                    container.addEventListener('dragover', dragOverHandler);
                    container.addEventListener('drop', dropHandler);
                } else {
                    container.removeEventListener('dragover', dragOverHandler);
                    container.removeEventListener('drop', dropHandler);
                }
            }

            function dragOverHandler(event) {
                event.preventDefault();
            }

            function dropHandler(event) {
                event.preventDefault();
                const id = event.dataTransfer.getData('text/plain');
                const draggableElement = document.getElementById(id);
                const rect = event.currentTarget.getBoundingClientRect();
                const x = event.clientX - rect.left - draggableElement.clientWidth / 2;
                const y = event.clientY - rect.top - draggableElement.clientHeight / 2;
                draggableElement.style.left = `${x}px`;
                draggableElement.style.top = `${y}px`;
                event.dataTransfer.clearData();
                saveButtonPosition(id, x, y);
            }

            async function saveButtonPosition(id, x, y) {
                const positions = JSON.parse(localStorage.getItem('buttonPositions')) || {};
                positions[id] = { x, y };
                localStorage.setItem('buttonPositions', JSON.stringify(positions));
                try {
                    await fetch('/save_positions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(positions)
                    });
                } catch (error) {
                    console.error('Error saving positions:', error);
                }
            }

            async function loadButtonPositions() {
                try {
                    const response = await fetch('/load_positions');
                    if (!response.ok) {
                        throw new Error(`Network response was not ok. Status: ${response.status}`);
                    }
                    const positions = await response.json();
                    localStorage.setItem('buttonPositions', JSON.stringify(positions));
                    return positions;
                } catch (error) {
                    console.error('Error loading positions:', error);
                    return JSON.parse(localStorage.getItem('buttonPositions')) || {};
                }
            }

            async function loadTables(tenant) {
                try {
                    const url = `/tenants_folders/${tenant}_upload_json/occupied_tables.json`;
                    console.log(`Fetching data from: ${url}`);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Network response was not ok. Status: ${response.status}`);
                    }
                    const tables = await response.json();
                    console.log('Tables data:', tables);
                    await loadTimeDiffs(tables, tenant);
                    const positions = await loadButtonPositions();
                    createTableButtons(tables, positions);
                } catch (error) {
                    console.error('Error loading tables:', error);
                }
            }

            async function loadTimeDiffs(tables, tenant) {
                try {
                    const url = `/list_order_files/${tenant}/`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Network response was not ok. Status: ${response.status}`);
                    }
                    const files = await response.json();
                    
                    for (const table of tables) {
                        const tableNumber = table.table_number;
                        const matchingFile = files.files.find(file => file.includes(`order_table_${tableNumber}_`));
                        if (matchingFile) {
                            const fileResponse = await fetch(`/tenants_folders/${tenant}_received_orders/${matchingFile}`);
                            if (fileResponse.ok) {
                                const orderData = await fileResponse.json();
                                const timeDiff = orderData.time_diff;
                                if (timeDiff !== undefined) {
                                    table.time_diff = convertMinutesToHHMM(timeDiff);
                                    await updateJsonFile(tenant, matchingFile);
                                }
                            } else {
                                table.time_diff = 'N/A';
                            }
                        } else {
                            table.time_diff = 'N/A';
                        }
                    }
                } catch (error) {
                    console.error('Error loading time_diff:', error);
                    tables.forEach(table => table.time_diff = 'N/A');
                }
            }

            async function updateJsonFile(tenant, filename) {
                const url = `/update_time_diff/${tenant}/${filename}`;
                try {
                    await fetch(url, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Error updating JSON file:', error);
                }
            }

            function convertMinutesToHHMM(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }

            function createTableButtons(tables, positions) {
                const container = document.querySelector('.tables-container');
                container.innerHTML = '';
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const buttonSize = Math.min(containerWidth, containerHeight) / 5;
                const fontSize = buttonSize / 5;
                const margin = buttonSize / 8;

                tables.forEach((table, index) => {
                    const button = document.createElement('a');
                    button.id = `table-${table.table_number}`;
                    button.href = `order_for_table/${table.table_number}/?name=${localStorage.getItem('waiterName')}&tenant=${getTenantFromHostname()}`;
                    button.className = table.duration ? 'occupied-button' : 'custom-button';

                    button.style.display = 'flex';
                    button.style.flexDirection = 'column';
                    button.style.justifyContent = 'center';
                    button.style.alignItems = 'center';
                    button.style.color = 'white';
                    button.style.textDecoration = 'none';
                    button.style.transition = 'all 0.3s ease';
                    button.style.padding = '10px';
                    button.style.borderRadius = '2px';
                    button.style.position = 'absolute';

                    if (positions[button.id]) {
                        button.style.left = `${positions[button.id].x}px`;
                        button.style.top = `${positions[button.id].y}px`;
                    } else {
                        button.style.left = `${(table.center_coordinates[0] / 800) * containerWidth - buttonSize / 2}px`;
                        button.style.top = `${(table.center_coordinates[1] / 600) * containerHeight - buttonSize / 2}px`;
                    }

                    button.style.width = `${buttonSize}px`;
                    button.style.height = `${buttonSize}px`;
                    button.style.margin = `${margin}px`;

                    const tableNumberDiv = document.createElement('div');
                    tableNumberDiv.className = 'table-number';
                    tableNumberDiv.style.fontSize = `${fontSize}px`;
                    tableNumberDiv.textContent = `${table.table_number}`;
                    button.appendChild(tableNumberDiv);

                    const tableDurationDiv = document.createElement('div');
                    tableDurationDiv.className = 'table-duration';
                    tableDurationDiv.style.fontSize = `${fontSize * 0.8}px`;
                    tableDurationDiv.textContent = table.duration;
                    button.appendChild(tableDurationDiv);

                    if (table.time_diff && table.time_diff !== 'N/A') {
                        console.log(`Table ${table.table_number} has time_diff: ${table.time_diff}`);
                        const timeDiffDiv = document.createElement('div');
                        timeDiffDiv.className = 'time-diff';
                        timeDiffDiv.style.fontSize = `${fontSize * 0.6}px`;
                        timeDiffDiv.textContent = `Taken: ${table.time_diff} ago`;
                        button.appendChild(timeDiffDiv);
                    }

                    if (isDragMode) {
                        enableDrag(button);
                    }

                    container.appendChild(button);
                });
            }

            function arrangeButtons() {
                const container = document.querySelector('.tables-container');
                const buttons = Array.from(container.querySelectorAll('a'));
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const buttonSize = Math.min(containerWidth, containerHeight) / 5;
                const margin = buttonSize / 8;

                buttons.sort((a, b) => {
                    const aNumber = parseInt(a.id.split('-')[1], 10);
                    const bNumber = parseInt(b.id.split('-')[1], 10);
                    return aNumber - bNumber;
                });

                buttons.forEach((button, index) => {
                    const x = (index % 5) * (buttonSize + margin);
                    const y = Math.floor(index / 5) * (buttonSize + margin);
                    button.style.left = `${x}px`;
                    button.style.top = `${y}px`;
                    saveButtonPosition(button.id, x, y);
                });
            }

            function resizeContainer() {
                const container = document.querySelector('.tables-container');
                const width = container.clientWidth;
                const height = width / 2;
                container.style.height = `${height}px`;
            }
        };

        function getTenantFromHostname() {
            const hostname = window.location.hostname;
            console.log(`Hostname: ${hostname}`);
            const tenant = hostname.split('.')[0];
            return tenant;
        }

        function updateHeader(waiterName, tenant) {
            const header = document.querySelector('.header h2');
            header.textContent = `Overview of: ${tenant}`;
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            position: relative;
            max-width: 98%;
            margin: 20px auto;
            padding: 20px;
            background-color: rgb(208, 212, 217);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .header {
            padding: 20px;
            background-color: #007bff;
            color: white;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }

        .header-buttons {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .header-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .header-buttons button:hover {
            background-color: #0056b3;
            color: white;
        }

        .header-buttons .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .header-buttons .btn-primary.active {
            background-color: #0056b3;
            color: white;
        }

        h2 {
            margin: 0;
            font-size: 1.5em;
            color: aliceblue;
        }

        .tables-container {
            position: relative;
            width: 100%;
            height: 75vh;
            overflow: hidden;
        }

        .custom-button {
            background-color: #4CAF50;
        }

        .custom-button:hover {
            background-color: #388E3C;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .occupied-button {
            background-color: #FF5722;
        }

        .occupied-button:hover {
            background-color: #711c02;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .table-number {
            font-size: bold 1.5em ;
            margin-bottom: 5px;
        }

        .table-duration {
            font-size: 1em;
            color: yellow;
            margin-bottom: 5px;
        }

        .time-diff {
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Overview</h2>
        </div>
        <div class="header-buttons">
            <button id="toggle-drag-mode" class="btn-primary">Change Tables Position</button>
            <button id="arrange-buttons" class="btn-primary">Arrange Tables</button>
        </div>
        <div class="tables-container"></div>
    </div>
</body>
</html>
